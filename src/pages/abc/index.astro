---
import Layout from '../../layouts/Layout.astro';

const collections = [
  { slug: 'old-time-jam-tunes', title: 'Old-Time' },
  { slug: 'irish-session-top100', title: 'The Session' },
  { slug: 'mandolin-cafe-bluegrass', title: 'Mandolin Cafe Bluegrass' },
  { slug: 'open-hymnal', title: 'Open Hymnal' },
  { slug: 'roaring-jelly-2024', title: 'Roaring Jelly' }
];
---

<Layout title="ABC Viewer & Editor" description="Render and edit ABC notation in your browser with playback and transposition." fullWidth>
  <section class="w-full px-2 sm:px-4 lg:px-6 xl:px-10 2xl:px-16 py-10">
    <h1 class="text-4xl font-bold text-white mb-3">ABC Viewer & Editor</h1>
    <div class="flex flex-wrap items-center gap-2 mb-4">
      {collections.map((c) => (
        <a href={`/abc/${c.slug}`} class="px-3 py-1 rounded bg-gray-800 border border-gray-700 text-blue-200 hover:text-white hover:bg-gray-700 text-sm">
          {c.title}
        </a>
      ))}
    </div>
    <p class="text-gray-300 mb-6">Paste your ABC below or open one of our curated collections. Uses abcjs to render sheet music in your browser.</p>

  <div class="grid grid-cols-1 gap-6 lg:grid-cols-[minmax(420px,1.9fr)_minmax(520px,1.15fr)] xl:grid-cols-[minmax(440px,1.95fr)_minmax(560px,1.05fr)]">
      <!-- Left column: controls + rendered song -->
      <div class="lg:col-span-1 h-[70vh] flex flex-col space-y-3">
        <div class="p-3 rounded bg-gray-800 border border-gray-700">
          <div class="flex items-center gap-4 flex-wrap">
            <div class="flex items-center gap-2">
              <button id="transposeDown" class="px-2 py-1 bg-gray-700 text-white rounded" title="Transpose down">&#9837;</button>
              <span id="currentKeyLabel" class="text-gray-100 font-semibold min-w-[2ch] text-center">K?</span>
              <button id="transposeUp" class="px-2 py-1 bg-gray-700 text-white rounded" title="Transpose up">&#9839;</button>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <input id="tempoSlider" type="range" min="40" max="220" value="120" class="w-16" />
              <span id="tempoLabel" class="text-gray-300 text-sm">120 BPM</span>
              <label class="text-sm text-gray-300 flex items-center gap-2">
                Render height
                <input id="renderScale" type="range" min="20" max="100" value="60" class="w-28" />
                <span id="renderScaleLabel" class="text-gray-300 text-sm">60%</span>
              </label>
              <button id="playToggle" class="px-3 py-1 bg-green-600 hover:bg-green-500 text-white rounded">Play</button>
              <button
                id="playbackModeToggle"
                class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-500 text-white"
                title="Playback Mode: Chords + Melody"
                type="button"
              >
                ðŸŽµ Mixed
              </button>
              <button
                id="highlightToggle"
                class="px-3 py-1 rounded border border-amber-500 text-amber-400 hover:bg-amber-500 hover:text-black"
                aria-pressed="false"
                type="button"
              >
                Highlight notes: Off
              </button>
            </div>
          </div>
        </div>

        <!-- Tabulature selection under play controls -->
        <div class="p-3 rounded bg-gray-800 border border-gray-700">
          <label class="block text-sm text-gray-300 mb-2">Tablature layer</label>
          <select id="layerSelect" class="w-full bg-black text-gray-200 border border-gray-700 rounded p-2 text-sm">
            <option value="none">None (Staff only)</option>
            <option value="guitar">Guitar</option>
            <option value="mandolin">Mandolin</option>
            <option value="ukulele">Ukulele</option>
            <option value="baritone">Baritone Ukulele</option>
          </select>
          <label class="text-sm text-gray-300 mt-2 block"><input id="stripChords" type="checkbox" class="mr-2" /> Strip quoted chords for tabs</label>
        </div>

        <div class="p-3 rounded bg-gray-900 border border-gray-800 flex-1 min-h-0 overflow-auto">
          <div id="paper" class="min-h-full h-full"></div>
        </div>
      </div>

      <!-- Middle column: editor + exports -->
      <div class="lg:col-span-1 h-[70vh] flex flex-col space-y-2">
        <div class="flex justify-end gap-2 mb-1 flex-wrap">
          <div class="flex gap-2">
            <button id="exportTuneAbc" class="px-3 py-1 bg-gray-700 text-white rounded" title="Export current as .abc">Tune .abc</button>
            <button id="exportFullAbc" class="px-3 py-1 bg-gray-700 text-white rounded" title="Export full text as .abc">Full .abc</button>
            <button id="exportPng" class="px-3 py-1 bg-gray-700 text-white rounded" title="Export rendered sheet as .png">PNG</button>
            <button id="exportMidi" class="px-3 py-1 bg-gray-700 text-white rounded" title="Export MIDI">MIDI</button>
          </div>
        </div>
        <textarea id="abcInput" class="w-full flex-1 min-h-0 p-3 font-mono text-sm rounded bg-black text-gray-200 border border-gray-700 resize-none" placeholder="Paste or type ABC notation here..."></textarea>
      </div>

      <!-- Right column removed: simplified to two-column layout -->
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/abcjs@6.4.4/dist/abcjs-basic-min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/abcjs@6.4.4/dist/abcjs-midi-min.js" defer></script>
  <style>
    /* Highlight style for the currently playing note */
    #paper .abc-current-note {
      fill: #f59e0b !important;       /* amber-500 */
      stroke: #f59e0b !important;
      opacity: 0.95;
    }
    /* Ensure common glyphs inherit highlight */
    #paper .abc-current-note path,
    #paper .abc-current-note polygon,
    #paper .abc-current-note polyline,
    #paper .abc-current-note use {
      fill: #f59e0b !important;
      stroke: #f59e0b !important;
    }
  </style>
  <script src="/abc/viewer.js" defer></script>
  <script src="/abc/init-viewer.js" defer></script>
